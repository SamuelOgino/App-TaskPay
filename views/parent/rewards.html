{% from 'shared/_macros.html' import flash_messages %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaskPay • Recompensas</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/rewards_parent.css') }}">
  <link rel="manifest" href="/manifest.json">
  
</head>
<body>
  <div class="phone">
    <header class="app-header">
      {{ flash_messages() }}
      <a href="{{ url_for('notificacoes.home_parent') }}" style="color:#fff"><i class="fa-solid fa-arrow-left"></i></a>
      <div class="logo"><i class="fa-solid fa-list"></i><span>TaskPay</span></div>
    </header>

    <main class="content-area">
      
      {% if plano_atual == 'FREE' %}
      <div class="pro-lock-overlay">
          <div class="lock-card">
              <div class="lock-icon">
                  <i class="fa-solid fa-lock"></i>
              </div>
              <h3 class="lock-title">Funcionalidade PRO</h3>
              <p class="lock-desc">A Loja de Recompensas e o Controle de XP são exclusivos para assinantes Premium.</p>
              
              <a href="{{ url_for('melhorarplano.plans_page') }}" class="btn primary">
                  Liberar Acesso Agora
              </a>
          </div>
      </div>
      {% endif %}

      <div class="{% if plano_atual == 'FREE' %}blur-content{% endif %}">

          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <h2 class="section-title">Recompensas</h2>
            <a class="btn green" href="{{ url_for('criarrecompensa.new_reward_page') }}"><i class="fa-solid fa-plus"></i> Nova Recompensa</a>
          </div>

          <div class="card">
            <h3 style="font-weight:700;margin-bottom:12px">Resumo de XP</h3>
            <div class="grid-two">
              {% for k in xp_por_filho %}
                <div class="kid-card">
                  <img src="{{ url_for('static', filename='uploads/' + k.avatar) if k.avatar else 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' }}" alt="{{k.nome}}">
                  <div style="flex:1">
                    <div style="font-weight:700">{{ k.nome }}</div>
                    <div class="xp"><i class="fa-solid fa-star"></i> {{ k.xp }} XP</div>
                  </div>
                </div>
              {% else %}
                <p style="color:var(--muted)">Sem filhos cadastrados nesta família.</p>
              {% endfor %}
            </div>
          </div>

          <div class="card">
            <h3 style="font-weight:700;margin-bottom:12px">Recompensas Ativas</h3>
            {% for r in ativas %}
              <div class="reward-item">
                <div>
                  <div class="title">{{ r.titulo }}</div>
                  <div class="cost">{{ r.custoXP }} XP</div>
                </div>
                </div>
            {% else %}
              <div class="reward-item">
                <div>Sem recompensas ativas</div>
              </div>
            {% endfor %}
          </div>

          <div class="card">
            <h3 style="font-weight:700;margin-bottom:12px">Recompensas Resgatadas</h3>
            {% for h in historico %}
              <div class="reward-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #eee;">
                <div style="flex: 1;">
                  <div class="title" style="font-weight: 700;">{{ h.recompensa.titulo if h.recompensa else 'Recompensa' }}</div>
                  <div class="cost" style="font-size: 0.85rem; color: var(--muted);">
                      Resgatado por <strong>{{ h.membro.usuario.nome }}</strong> • {{ h.xpPago }} XP
                  </div>
                  </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    {% if h.status == 'PENDING' %}
                        <a href="{{ url_for('resgatar.deliver_reward', resgate_id=h.id) }}" 
                           onclick="return confirm('Confirmar entrega?');"
                           style="background-color: #dcfce7; color: #166534; padding: 6px 12px; border-radius: 8px; text-decoration: none; font-size: 0.85rem; font-weight: 600; border: 1px solid #bbf7d0;">
                           <i class="fa-solid fa-check"></i>
                        </a>
                        <a href="{{ url_for('resgatar.reject_reward', resgate_id=h.id) }}" 
                           onclick="return confirm('Rejeitar e devolver XP?');"
                           style="background-color: #fee2e2; color: #991b1b; padding: 6px 12px; border-radius: 8px; text-decoration: none; font-size: 0.85rem; font-weight: 600; border: 1px solid #fecaca;">
                           <i class="fa-solid fa-xmark"></i>
                        </a>
                    {% else %}
                        <span class="badge" style="font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; background-color: #f3f4f6; color: #6b7280;">
                            {{ h.status }}
                        </span>
                    {% endif %}
                </div>
              </div>
            {% else %}
              <div class="reward-item">
                <div style="color: var(--muted); text-align: center; padding: 20px;">Sem resgates no histórico</div>
              </div>
            {% endfor %}
          </div>

      </div> </main>

    <footer class="app-footer-nav">
          <a href="{{ url_for('notificacoes.home_parent') }}" class="nav-item"> 
            <i class="fa-solid fa-house"></i>
              <span>Início</span>
          </a>
          <a href="{{ url_for('taskssubmission.tasks_page') }}" class="nav-item">
              <i class="fa-solid fa-list-check"></i>
              <span>Tarefas</span>
          </a>
          <a href="{{ url_for('resgatar.manage_page') }}" class="nav-item active">
              <i class="fa-solid fa-gift"></i>
              <span>Recompensas</span>
          </a>
          <a href="{{ url_for('carteira.profile_page') }}" class="nav-item">
              <i class="fa-solid fa-user"></i>
              <span>Perfil</span>
          </a>
      </footer>
      <script src="{{ url_for('static', filename='js/flash_me.js') }}"></script>
  </div>
</body>
</html>